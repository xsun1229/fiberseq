---
title: "Annotate footprints by location -- 15 states from ChromHMM"
author: "XSun"
date: "2026-02-19"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---


```{r}

suppressPackageStartupMessages({
  library(data.table)
  library(ggplot2)
  library(patchwork)
})

source("/project/spott/xsun/fiberseq/2.annotating_footprints/0.functions.R")
```

# Overview

To quantify **where Fiber-seq footprints preferentially occur in the genome**, we measured their overlap with the **Roadmap Epigenomics ChromHMM core 15-state segmentation**.

Because different chromatin states occupy very different fractions of the genome, we compute **genome-background–normalized enrichment** to determine whether footprints are over- or under-represented in each state.


| STATE NO. | MNEMONIC | DESCRIPTION |
|-----------|----------|-------------|
| 1  | TssA      | Active TSS |
| 2  | TssAFlnk  | Flanking Active TSS |
| 3  | TxFlnk    | Transcription at gene 5' and 3' |
| 4  | Tx        | Strong transcription |
| 5  | TxWk      | Weak transcription |
| 6  | EnhG      | Genic enhancers |
| 7  | Enh       | Enhancers |
| 8  | ZNF/Rpts  | ZNF genes & repeats |
| 9  | Het       | Heterochromatin |
| 10 | TssBiv    | Bivalent/Poised TSS |
| 11 | BivFlnk   | Flanking Bivalent TSS/Enh |
| 12 | EnhBiv    | Bivalent Enhancer |
| 13 | ReprPC    | Repressed PolyComb |
| 14 | ReprPCWk  | Weak Repressed PolyComb |
| 15 | Quies     | Quiescent/Low |

---

## Data Source

ChromHMM segmentations were downloaded from the Roadmap Epigenomics portal: https://egg2.wustl.edu/roadmap/data/byFileType/chromhmmSegmentations/ChmmModels/coreMarks/jointModel/final/

We used: `E116_15_coreMarks_hg38lift_mnemonics.bed.gz`


**E116 corresponds to GM12878 (lymphoblastoid cells)**, which is the closest Roadmap epigenome match to our LCL cell line (based on the Roadmap epigenome metadata table).

---

## Overlap Definition (Any-Overlap)

We used an **any-overlap** criterion:

> A footprint is considered to overlap a ChromHMM state if it shares **≥ 1 bp** with that state interval.

---

## Footprint Percentage per State

For each footprint bin (or footprint set), we computed:

- `n_fp`: total number of footprints  
- `n_any`: number of footprints overlapping the state (≥ 1 bp)  
- `pct_any`: percentage of footprints overlapping the state  

\[
\%Footprints(state) = 100 \times \frac{n_{any}}{n_{fp}}
\]

All 15 states are retained in the summary table.  
States with no overlaps are recorded as `n_any = 0`.

---

## Genome Background Calculation

To account for unequal genomic coverage of states, we computed:

- `%Genome(state)` = proportion of the genome annotated as that state

This value is calculated directly from the ChromHMM segmentation.

---

## Enrichment Calculation

We define enrichment as:

\[
Enrichment(state) = \frac{\%Footprints(state)}{\%Genome(state)}
\]

---

# Results

- `n_fp`: total number of footprints  
- `n_any`: number of footprints overlapping the state (≥ 1 bp)  
- `pct_any`: percentage of footprints overlapping the state 


```{r warning=FALSE, message=FALSE, fig.height=5, fig.width=16}

summary_any_by_state <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/any_overlap_with_ChromHMM_by_state.RDS")
summary_any_by_state <- summary_any_by_state[,-c("hex","fp_len_hi")]
col_map <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/any_overlap_with_ChromHMM_by_state_colmap.RDS")
label_map <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/any_overlap_with_ChromHMM_by_state_labelmap.RDS")

DT::datatable(summary_any_by_state,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;',''),options = list(pageLength = 10) )


p_pct <- ggplot(summary_any_by_state,
                aes(x = fp_length, y = pct_any, color = factor(state_id), group = state_id)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.2) +
  scale_color_manual(values = col_map, labels = label_map) +
  labs(x = "Footprint length bin",
       y = "% footprints overlapping ChromHMM (any overlap)",
       color = "ChromHMM state") +
  theme_classic(base_size = 13) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))


p_cnt <- ggplot(summary_any_by_state,
                aes(x = fp_length, y = n_any, color = factor(state_id), group = state_id)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.2) +
  scale_color_manual(values = col_map, labels = label_map) +
  labs(x = "Footprint length bin",
       y = "# footprints overlapping ChromHMM (any overlap)",
       color = "ChromHMM state") +
  theme_classic(base_size = 13) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))


p_enrich <- ggplot(summary_any_by_state,
                   aes(x = fp_length, y = enrichment, color = factor(state_id), group = state_id)) +
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.8, color = "black") +
  geom_line(linewidth = 1) +
  geom_point(size = 2.2) +
  scale_color_manual(values = col_map, labels = label_map) +
  labs(x = "Footprint length bin",
       y = "Enrichment over genome background",
       color = "ChromHMM state") +
  theme_classic(base_size = 13) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

p_pct + p_cnt+ p_enrich

```
