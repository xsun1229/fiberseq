---
title: "Determine the footprint cutoffs (p-value, q-value, fold-enrichment, pileup)"
author: "XSun"
date: "2026-02-23"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---


```{r}

library(ggplot2)
library(patchwork)
library(data.table)

label_map <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/any_overlap_with_ChromHMM_by_state_labelmap.RDS")
col_map <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/any_overlap_with_ChromHMM_by_state_colmap.RDS")
```

# Introduction

MACS peak calling results include p-value, q-value, peak summit pileup counts and fold-enrichment. We vary the cutoffs for these parameters to see if we can see higher ChromHMM enrichment using the stronger footprints.

The footprints are storaged here: `/project/spott/1_Shared_projects/LCL_Fiber_seq/FiberHMM/merged/combined/joint_trained_peaks`

# Single filter

## q-value

```{r fig.height=5, fig.width=13}

summary_any_by_state <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/fp_vary_para/any_overlap_with_ChromHMM_by_state_filtered_by_qcutoff.RDS")

dt <- copy(summary_any_by_state)

# ---- 1) Merge footprint bins (ROBUST to factor/character) ----
dt[, fp_length_merged := as.character(fp_length)]
dt[fp_length_merged %in% c("30-45bp", "45-60bp"),
   fp_length_merged := "30-60bp"]

# Order factor levels for plotting (adjust levels if you have more bins)
dt[, fp_length_merged := factor(
  fp_length_merged,
  levels = c("10-30bp", "30-60bp", "60-80bp")
)]

# ---- 2) Recalculate n_fp per merged bin ----
# n_fp is duplicated per state within (fp_length, q_cutoff), so take max after merging
dt_nfp_q_merged <- dt[
  , .(n_fp = max(n_fp)),
  by = .(fp_length_merged, q_cutoff)
]

# ---- 3) Recalculate enrichment after merging ----
# pct_any is the % of footprints in a given state (for that fp_length/q cutoff)
# After merging bins, sum pct_any and n_any across the merged bins
dt_enrich_merged <- dt[
  , .(
    n_any      = sum(n_any),
    pct_any    = sum(pct_any),
    pct_genome = unique(pct_genome)  # same per state
  ),
  by = .(state_id, mnemonic, description, hex, state_label,
         fp_length_merged, q_cutoff)
]

dt_enrich_merged[, enrichment := pct_any / pct_genome]

# ---- 4) Plot: number of peaks ----
p_n_fp <- ggplot(
  dt_nfp_q_merged,
  aes(x = q_cutoff, y = n_fp,
      group = fp_length_merged, color = fp_length_merged)
) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.2) +
  theme_classic(base_size = 13) +
  labs(
    x = "q-value cutoff",
    y = "Number of peaks (n_fp)",
    color = "Footprint length"
  ) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# ---- 5) Plot: ChromHMM enrichment ----
p_enrich_q <- ggplot(
  dt_enrich_merged,
  aes(x = fp_length_merged, y = enrichment,
      color = factor(state_id), group = state_id)
) +
  geom_hline(yintercept = 1, linetype = "dashed",
             linewidth = 0.8, color = "black") +
  geom_line(linewidth = 1) +
  geom_point(size = 2.0) +
  facet_wrap(~ q_cutoff, nrow = 1) +
  scale_color_manual(values = col_map, labels = label_map) +
  labs(
    x = "Footprint length bin",
    y = "Enrichment over genome background",
    color = "ChromHMM state"
  ) +
  theme_classic(base_size = 13) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# ---- 6) Combine plots ----
p_n_fp + p_enrich_q +
  plot_layout(widths = c(1, 2.4))


```


## p-value

```{r fig.height=5, fig.width=13}

summary_any_by_state <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/fp_vary_para/any_overlap_with_ChromHMM_by_state_filtered_by_pcutoff.RDS")

dt <- copy(summary_any_by_state)

# ---- 1) Merge footprint bins (ROBUST to factor/character) ----
dt[, fp_length_merged := as.character(fp_length)]
dt[fp_length_merged %in% c("30-45bp", "45-60bp"),
   fp_length_merged := "30-60bp"]

# Order factor levels for plotting (adjust if you have more bins)
dt[, fp_length_merged := factor(
  fp_length_merged,
  levels = c("10-30bp", "30-60bp", "60-80bp")
)]

# ---- 2) Recalculate n_fp per merged bin ----
# n_fp is duplicated per state within (fp_length, p_cutoff), so take max after merging
dt_nfp_p_merged <- dt[
  , .(n_fp = max(n_fp)),
  by = .(fp_length_merged, p_cutoff)
]

# ---- 3) Recalculate enrichment after merging ----
dt_enrich_p_merged <- dt[
  , .(
    n_any      = sum(n_any),
    pct_any    = sum(pct_any),
    pct_genome = unique(pct_genome)
  ),
  by = .(state_id, mnemonic, description, hex, state_label,
         fp_length_merged, p_cutoff)
]

dt_enrich_p_merged[, enrichment := pct_any / pct_genome]

# ---- 4) Plot: number of peaks ----
p_n_fp <- ggplot(
  dt_nfp_p_merged,
  aes(x = p_cutoff, y = n_fp,
      group = fp_length_merged, color = fp_length_merged)
) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.2) +
  theme_classic(base_size = 13) +
  labs(
    x = "p-value cutoff",
    y = "Number of peaks (n_fp)",
    color = "Footprint length"
  ) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# ---- 5) Plot: ChromHMM enrichment ----
p_enrich_p <- ggplot(
  dt_enrich_p_merged,
  aes(x = fp_length_merged, y = enrichment,
      color = factor(state_id), group = state_id)
) +
  geom_hline(yintercept = 1, linetype = "dashed",
             linewidth = 0.8, color = "black") +
  geom_line(linewidth = 1) +
  geom_point(size = 2.0) +
  facet_wrap(~ p_cutoff, nrow = 1) +
  scale_color_manual(values = col_map, labels = label_map) +
  labs(
    x = "Footprint length bin",
    y = "Enrichment over genome background",
    color = "ChromHMM state"
  ) +
  theme_classic(base_size = 13) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# ---- 6) Combine plots ----
p_n_fp + p_enrich_p +
  plot_layout(widths = c(1, 2.4))

```

## the peak summit pileup counts

```{r fig.height=5, fig.width=13}

summary_any_by_state <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/fp_vary_para/any_overlap_with_ChromHMM_by_state_filtered_by_pileup.RDS")

dt <- copy(summary_any_by_state)

# ---- 1) Merge footprint bins (ROBUST to factor/character) ----
dt[, fp_length_merged := as.character(fp_length)]
dt[fp_length_merged %in% c("30-45bp", "45-60bp"),
   fp_length_merged := "30-60bp"]

# Order factor levels for plotting (adjust if you have more bins)
dt[, fp_length_merged := factor(
  fp_length_merged,
  levels = c("10-30bp", "30-60bp", "60-80bp")
)]

# ---- 2) Recalculate n_fp per merged bin ----
# n_fp is duplicated per state within (fp_length, pileup_cutoff), so take max after merging
dt_nfp_pileup_merged <- dt[
  , .(n_fp = max(n_fp)),
  by = .(fp_length_merged, pileup_cutoff)
]

# ---- 3) Recalculate enrichment after merging ----
dt_enrich_pileup_merged <- dt[
  , .(
    n_any      = sum(n_any),
    pct_any    = sum(pct_any),
    pct_genome = unique(pct_genome)
  ),
  by = .(state_id, mnemonic, description, hex, state_label,
         fp_length_merged, pileup_cutoff)
]

dt_enrich_pileup_merged[, enrichment := pct_any / pct_genome]

# ---- 4) Plot: number of peaks ----
p_n_fp <- ggplot(
  dt_nfp_pileup_merged,
  aes(x = pileup_cutoff, y = n_fp,
      group = fp_length_merged, color = fp_length_merged)
) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.2) +
  theme_classic(base_size = 13) +
  labs(
    x = "pileup cutoff",
    y = "Number of peaks (n_fp)",
    color = "Footprint length"
  ) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# ---- 5) Plot: ChromHMM enrichment ----
p_enrich_pileup <- ggplot(
  dt_enrich_pileup_merged,
  aes(x = fp_length_merged, y = enrichment,
      color = factor(state_id), group = state_id)
) +
  geom_hline(yintercept = 1, linetype = "dashed",
             linewidth = 0.8, color = "black") +
  geom_line(linewidth = 1) +
  geom_point(size = 2.0) +
  facet_wrap(~ pileup_cutoff, nrow = 1) +
  scale_color_manual(values = col_map, labels = label_map) +
  labs(
    x = "Footprint length bin",
    y = "Enrichment over genome background",
    color = "ChromHMM state"
  ) +
  theme_classic(base_size = 13) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# ---- 6) Combine plots ----
p_n_fp + p_enrich_pileup +
  plot_layout(widths = c(1, 2.4))

```

## fold-enrichment

```{r fig.height=5, fig.width=13}

summary_any_by_state <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/fp_vary_para/any_overlap_with_ChromHMM_by_state_filtered_by_fold_enrichment.RDS")

dt <- copy(summary_any_by_state)

# ---- 1) Merge footprint bins (ROBUST to factor/character) ----
dt[, fp_length_merged := as.character(fp_length)]
dt[fp_length_merged %in% c("30-45bp", "45-60bp"),
   fp_length_merged := "30-60bp"]

# Order factor levels for plotting (adjust if you have more bins)
dt[, fp_length_merged := factor(
  fp_length_merged,
  levels = c("10-30bp", "30-60bp", "60-80bp")
)]

# ---- 2) Recalculate n_fp per merged bin ----
# n_fp is duplicated per state within (fp_length, fe_cutoff), so take max after merging
dt_nfp_fe_merged <- dt[
  , .(n_fp = max(n_fp)),
  by = .(fp_length_merged, fe_cutoff)
]

# ---- 3) Recalculate enrichment after merging ----
dt_enrich_fe_merged <- dt[
  , .(
    n_any      = sum(n_any),
    pct_any    = sum(pct_any),
    pct_genome = unique(pct_genome)
  ),
  by = .(state_id, mnemonic, description, hex, state_label,
         fp_length_merged, fe_cutoff)
]

dt_enrich_fe_merged[, enrichment := pct_any / pct_genome]

# ---- 4) Plot: number of peaks ----
p_n_fp <- ggplot(
  dt_nfp_fe_merged,
  aes(x = fe_cutoff, y = n_fp,
      group = fp_length_merged, color = fp_length_merged)
) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.2) +
  theme_classic(base_size = 13) +
  labs(
    x = "Fold-enrichment threshold",
    y = "Number of peaks (n_fp)",
    color = "Footprint length"
  ) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# ---- 5) Plot: ChromHMM enrichment ----
p_enrich_fe <- ggplot(
  dt_enrich_fe_merged,
  aes(x = fp_length_merged, y = enrichment,
      color = factor(state_id), group = state_id)
) +
  geom_hline(yintercept = 1, linetype = "dashed",
             linewidth = 0.8, color = "black") +
  geom_line(linewidth = 1) +
  geom_point(size = 2.0) +
  facet_wrap(~ fe_cutoff, nrow = 1) +
  scale_color_manual(values = col_map, labels = label_map) +
  labs(
    x = "Footprint length bin",
    y = "Enrichment over genome background",
    color = "ChromHMM state"
  ) +
  theme_classic(base_size = 13) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# ---- 6) Combine plots ----
p_n_fp + p_enrich_fe +
  plot_layout(widths = c(1, 2.4))

```


# Combination of filters

## q-value < 0.001 & fold enrichment > 3

```{r fig.height=5, fig.width=13}

summary_joint <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/any_overlap_with_ChromHMM_by_state_filtered_by_q0.001_fe3.RDS")


dt_nfp <- unique(summary_joint[, .(fp_length, n_fp)])

p_n_fp <- ggplot(dt_nfp, aes(x = fp_length, y = n_fp, fill = fp_length)) +
  geom_col() +
  theme_classic(base_size = 13) +
  labs(x = "Footprint bin",
       y = "Number of peaks retained") +
  theme(legend.position = "none")


p_enrich_q <- ggplot(summary_joint,
       aes(x = fp_length, y = enrichment,
           color = factor(state_id),
           group = state_id)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_manual(values = col_map, labels = label_map) +
  theme_classic(base_size = 13) +
  labs(x = "Footprint bin",
       y = "Enrichment over genome background",
       color = "ChromHMM state") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

p_n_fp + p_enrich_q +
  plot_layout(widths = c(1, 2.4))


```

```{r fig.height=5, fig.width=13}

summary_joint <- summary_joint[summary_joint$fp_length != "60-80bp",]


dt_nfp <- unique(summary_joint[, .(fp_length, n_fp)])

p_n_fp <- ggplot(dt_nfp, aes(x = fp_length, y = n_fp, fill = fp_length)) +
  geom_col() +
  theme_classic(base_size = 13) +
  labs(x = "Footprint bin",
       y = "Number of peaks retained") +
  theme(legend.position = "none")


p_enrich_q <- ggplot(summary_joint,
       aes(x = fp_length, y = enrichment,
           color = factor(state_id),
           group = state_id)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_manual(values = col_map, labels = label_map) +
  theme_classic(base_size = 13) +
  labs(x = "Footprint bin",
       y = "Enrichment over genome background",
       color = "ChromHMM state") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

p_n_fp + p_enrich_q +
  plot_layout(widths = c(1, 2.4))


```


We checked how footprints are distributed across 15 ChromHMM states. The base-pair overlap was computed by intersecting Fiber-seq footprint intervals with ChromHMM state intervals and summing the number of overlapping base pairs for each state.


```{r fig.height=5, fig.width=13}

dt_pie_bp <- readRDS("/project/spott/xsun/fiberseq/2.annotating_footprints/results/footprint_dist_q0.001_fe3.RDS")


p_pie_bp <- ggplot(dt_pie_bp,
                   aes(x = "", y = pct_bp, fill = factor(state_id))) +
  geom_col(width = 1, color = "white", linewidth = 0.2) +
  coord_polar(theta = "y") +
  facet_wrap(~ fp_bin, nrow = 1) +
  scale_fill_manual(values = col_map, labels = label_map) +
  theme_void(base_size = 12) +
  labs(fill = "ChromHMM state",
       title = "Footprint bp distribution (q < 0.001 & FE > 3)") +
  theme(strip.text = element_text(size = 12))

p_pie_bp

DT::datatable(dt_pie_bp[dt_pie_bp$fp_bin == "10-30bp",c("state_id","state_label","pct_bp","fp_bin")],caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Distribution for 10-30bp'),options = list(pageLength = 20) )


DT::datatable(dt_pie_bp[dt_pie_bp$fp_bin == "30-60bp",c("state_id","state_label","pct_bp","fp_bin")],caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Distribution for 30-60bp'),options = list(pageLength = 20) )


DT::datatable(dt_pie_bp[dt_pie_bp$fp_bin == "60-80bp",c("state_id","state_label","pct_bp","fp_bin")],caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Distribution for 60-80bp'),options = list(pageLength = 20) )
```









